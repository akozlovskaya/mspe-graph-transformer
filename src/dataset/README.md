# Dataset Module

–ú–æ–¥—É–ª—å –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ –∏ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –≥—Ä–∞—Ñ–æ–≤—ã—Ö –¥–∞—Ç–∞—Å–µ—Ç–æ–≤ —Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π Multi-Scale Structural Positional Encodings (MSPE).

## üéØ –û—Å–Ω–æ–≤–Ω—ã–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏

- **–£–Ω–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω–Ω—ã–π API** –¥–ª—è –≤—Å–µ—Ö –¥–∞—Ç–∞—Å–µ—Ç–æ–≤
- **–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ –∏ –ø–æ–¥–≥–æ—Ç–æ–≤–∫–∞** –¥–∞–Ω–Ω—ã—Ö
- **–í—Å—Ç—Ä–æ–µ–Ω–Ω–∞—è –ø–æ–¥–¥–µ—Ä–∂–∫–∞ PE** —á–µ—Ä–µ–∑ transforms
- **–°–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å —Å PyTorch Geometric**
- **–ü–æ–¥–¥–µ—Ä–∂–∫–∞ –º–Ω–æ–∂–µ—Å—Ç–≤–∞ –¥–∞—Ç–∞—Å–µ—Ç–æ–≤**: ZINC, QM9, LRGB, OGB, PCQM, —Å–∏–Ω—Ç–µ—Ç–∏—á–µ—Å–∫–∏–µ –≥—Ä–∞—Ñ—ã

## üì¶ –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã–µ –¥–∞—Ç–∞—Å–µ—Ç—ã

### Molecular
- **ZINC**: –ú–æ–ª–µ–∫—É–ª—è—Ä–Ω—ã–π –¥–∞—Ç–∞—Å–µ—Ç –¥–ª—è —Ä–µ–≥—Ä–µ—Å—Å–∏–∏
- **QM9**: –ö–≤–∞–Ω—Ç–æ–≤–æ-–º–µ—Ö–∞–Ω–∏—á–µ—Å–∫–∏–µ —Å–≤–æ–π—Å—Ç–≤–∞ –º–æ–ª–µ–∫—É–ª

### LRGB
- **Peptides-func**: –§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–µ —Å–≤–æ–π—Å—Ç–≤–∞ –ø–µ–ø—Ç–∏–¥–æ–≤
- **Peptides-struct**: –°—Ç—Ä—É–∫—Ç—É—Ä–Ω—ã–µ —Å–≤–æ–π—Å—Ç–≤–∞ –ø–µ–ø—Ç–∏–¥–æ–≤
- **PascalVOC-SP**: Superpixel –≥—Ä–∞—Ñ—ã –∏–∑ PascalVOC
- **CIFAR10-SP**: Superpixel –≥—Ä–∞—Ñ—ã –∏–∑ CIFAR10

### OGB
- **ogbg-molhiv**: –ë–∏–Ω–∞—Ä–Ω–∞—è –∫–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü–∏—è HIV –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏
- **ogbg-molpcba**: –ú—É–ª—å—Ç–∏-–∑–∞–¥–∞—á–Ω–∞—è –∫–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü–∏—è PCBA
- **PCQM4M**: –ö–≤–∞–Ω—Ç–æ–≤—ã–µ —Å–≤–æ–π—Å—Ç–≤–∞ –º–æ–ª–µ–∫—É–ª (4M –≥—Ä–∞—Ñ–æ–≤)
- **PCQM-Contact**: Edge prediction –∑–∞–¥–∞—á–∞

### Synthetic
- **synthetic_grid_2d**: 2D —Å–µ—Ç–∫–∏
- **synthetic_grid_3d**: 3D —Å–µ—Ç–∫–∏
- **synthetic_ring**: –ö–æ–ª—å—Ü–µ–≤—ã–µ –≥—Ä–∞—Ñ—ã
- **synthetic_tree**: –°–±–∞–ª–∞–Ω—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –¥–µ—Ä–µ–≤—å—è
- **synthetic_random_regular**: –°–ª—É—á–∞–π–Ω—ã–µ —Ä–µ–≥—É–ª—è—Ä–Ω—ã–µ –≥—Ä–∞—Ñ—ã
- **synthetic_barabasi_albert**: –ì—Ä–∞—Ñ—ã –ë–∞—Ä–∞–±–∞—à–∏-–ê–ª—å–±–µ—Ä—Ç–∞
- **synthetic_watts_strogatz**: –ì—Ä–∞—Ñ—ã –£–æ—Ç—Ç—Å–∞-–°—Ç—Ä–æ–≥–∞—Ü–∞
- **synthetic_erdos_renyi**: –ì—Ä–∞—Ñ—ã –≠—Ä–¥—ë—à–∞-–†–µ–Ω—å–∏

## üöÄ –ë—ã—Å—Ç—Ä—ã–π —Å—Ç–∞—Ä—Ç

### –ë–∞–∑–æ–≤–æ–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ

```python
from src.dataset import get_dataset
from torch_geometric.data import DataLoader

# –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞—Ç–∞—Å–µ—Ç–∞ —Å PE
dataset = get_dataset(
    name="zinc",
    root="./data",
    pe_config={
        "node": {
            "enabled": True,
            "types": ["rwse"],
            "dim": 32,
            "scales": [1, 2, 4, 8]
        },
        "relative": {
            "enabled": True,
            "types": ["spd"],
            "max_distance": 10,
            "num_buckets": 16
        }
    }
)

# –°–æ–∑–¥–∞–Ω–∏–µ DataLoader
train_loader = DataLoader(dataset.train, batch_size=32, shuffle=True)

# –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –≤ —Ü–∏–∫–ª–µ –æ–±—É—á–µ–Ω–∏—è
for batch in train_loader:
    print(f"Batch size: {batch.batch.max().item() + 1}")
    print(f"Node features: {batch.x.shape}")
    print(f"Node PE: {batch.node_pe.shape}")
    print(f"Edge PE: {batch.edge_pe.shape}")
    print(f"Targets: {batch.y.shape}")
```

### –ó–∞–≥—Ä—É–∑–∫–∞ LRGB –¥–∞—Ç–∞—Å–µ—Ç–∞

```python
dataset = get_dataset(
    name="peptides_func",
    root="./data",
    pe_config={
        "node": {"enabled": True, "types": ["lap_pe", "rwse"], "dim": 32},
        "relative": {"enabled": True, "types": ["spd", "diffusion"], "num_buckets": 32}
    }
)
```

### –°–∏–Ω—Ç–µ—Ç–∏—á–µ—Å–∫–∏–µ –≥—Ä–∞—Ñ—ã

```python
# –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∫–æ–ª—å—Ü–µ–≤—ã—Ö –≥—Ä–∞—Ñ–æ–≤
dataset = get_dataset(
    name="synthetic_ring",
    root="./data",
    num_graphs=1000,
    graph_params={"n": 20},  # 20 —É–∑–ª–æ–≤ –≤ –∫–∞–∂–¥–æ–º –≥—Ä–∞—Ñ–µ
    pe_config={"node": {"enabled": True}, "relative": {"enabled": True}}
)

# –ì–µ–Ω–µ—Ä–∞—Ü–∏—è 2D —Å–µ—Ç–æ–∫
dataset = get_dataset(
    name="synthetic_grid_2d",
    num_graphs=500,
    graph_params={"m": 10, "n": 10},  # 10x10 —Å–µ—Ç–∫–∞
    pe_config={"node": {"enabled": True}, "relative": {"enabled": True}}
)
```

## üîß –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è PE

### Node-wise PE

```python
node_pe_config = {
    "enabled": True,
    "types": ["lap_pe", "rwse", "hks"],  # –¢–∏–ø—ã PE
    "dim": 32,                            # –†–∞–∑–º–µ—Ä–Ω–æ—Å—Ç—å PE
    "scales": [1, 2, 4, 8]                # –ú–∞—Å—à—Ç–∞–±—ã –¥–ª—è multi-scale
}
```

### Relative PE

```python
relative_pe_config = {
    "enabled": True,
    "types": ["spd", "diffusion", "effective_resistance"],
    "max_distance": 10,                   # –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ —Ä–∞—Å—Å—Ç–æ—è–Ω–∏–µ
    "num_buckets": 16                     # –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –±–∞–∫–µ—Ç–æ–≤
}
```

## üìä –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –¥–∞–Ω–Ω—ã—Ö

–ö–∞–∂–¥—ã–π –≥—Ä–∞—Ñ –≤ –¥–∞—Ç–∞—Å–µ—Ç–µ –∏–º–µ–µ—Ç —Å–ª–µ–¥—É—é—â—É—é —Å—Ç—Ä—É–∫—Ç—É—Ä—É:

```python
Data(
    x=torch.Tensor,           # Node features [num_nodes, num_features]
    edge_index=torch.Tensor,   # Edge indices [2, num_edges]
    edge_attr=torch.Tensor,   # Edge attributes [num_edges, edge_dim] (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
    node_pe=torch.Tensor,      # Node positional encodings [num_nodes, pe_dim]
    edge_pe=torch.Tensor,     # Relative positional encodings [num_edges, num_buckets]
    y=torch.Tensor,           # Target [num_targets] –∏–ª–∏ [1]
    pos=torch.Tensor,         # Node positions (–µ—Å–ª–∏ –¥–æ—Å—Ç—É–ø–Ω—ã) [num_nodes, 2/3]
)
```

## üõ†Ô∏è –£—Ç–∏–ª–∏—Ç—ã

### –í—ã—á–∏—Å–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –¥–∞—Ç–∞—Å–µ—Ç–∞

```python
from src.dataset.utils import compute_dataset_stats

stats = compute_dataset_stats(dataset.train)
print(f"Average nodes: {stats['avg_num_nodes']}")
print(f"Average edges: {stats['avg_num_edges']}")
print(f"Target mean: {stats.get('target_mean', 'N/A')}")
```

### –°–æ–∑–¥–∞–Ω–∏–µ —Å–ª—É—á–∞–π–Ω—ã—Ö split'–æ–≤

```python
from src.dataset.utils import create_random_split

train_idx, val_idx, test_idx = create_random_split(
    dataset, train_ratio=0.8, val_ratio=0.1, seed=42
)
```

### –ù–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è —Ç–∞—Ä–≥–µ—Ç–æ–≤

```python
from src.dataset.utils import normalize_targets

mean, std = normalize_targets(dataset.train)
```

## üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

–ó–∞–ø—É—Å–∫ —Ç–µ—Å—Ç–æ–≤:

```bash
pytest tests/test_dataset_loading.py -v
```

## üìù API Reference

### `get_dataset(name, root, pe_config, **kwargs)`

–§–∞–±—Ä–∏—á–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –¥–∞—Ç–∞—Å–µ—Ç–∞.

**–ü–∞—Ä–∞–º–µ—Ç—Ä—ã:**
- `name` (str): –ò–º—è –¥–∞—Ç–∞—Å–µ—Ç–∞
- `root` (str): –ö–æ—Ä–Ω–µ–≤–∞—è –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—è –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö
- `pe_config` (dict): –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –ø–æ–∑–∏—Ü–∏–æ–Ω–Ω—ã—Ö –∫–æ–¥–∏—Ä–æ–≤–æ–∫
- `**kwargs`: –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –¥–ª—è –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ –¥–∞—Ç–∞—Å–µ—Ç–∞

**–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç:**
- `BaseGraphDataset`: –≠–∫–∑–µ–º–ø–ª—è—Ä –¥–∞—Ç–∞—Å–µ—Ç–∞ —Å –∞—Ç—Ä–∏–±—É—Ç–∞–º–∏ `train`, `val`, `test`

### `BaseGraphDataset`

–ë–∞–∑–æ–≤—ã–π –∫–ª–∞—Å—Å –¥–ª—è –≤—Å–µ—Ö –¥–∞—Ç–∞—Å–µ—Ç–æ–≤.

**–ú–µ—Ç–æ–¥—ã:**
- `load()`: –ó–∞–≥—Ä—É–∂–∞–µ—Ç train/val/test splits
- `get_splits(splits="official")`: –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å–ª–æ–≤–∞—Ä—å —Å splits

**–°–≤–æ–π—Å—Ç–≤–∞:**
- `num_features`: –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø—Ä–∏–∑–Ω–∞–∫–æ–≤ —É–∑–ª–æ–≤
- `num_classes`: –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∫–ª–∞—Å—Å–æ–≤ (1 –¥–ª—è —Ä–µ–≥—Ä–µ—Å—Å–∏–∏)

### Transforms

- `ApplyNodePE`: –ü—Ä–∏–º–µ–Ω—è–µ—Ç node-wise PE
- `ApplyRelativePE`: –ü—Ä–∏–º–µ–Ω—è–µ—Ç relative PE
- `CompositeTransform`: –ö–æ–º–ø–æ–∑–∏—Ç–Ω—ã–π transform –¥–ª—è –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö transforms
- `NormalizeTargets`: –ù–æ—Ä–º–∞–ª–∏–∑—É–µ—Ç —Ç–∞—Ä–≥–µ—Ç—ã
- `CastDataTypes`: –ü—Ä–∏–≤–æ–¥–∏—Ç —Ç–∏–ø—ã –¥–∞–Ω–Ω—ã—Ö

## üîç –ü—Ä–∏–º–µ—Ä—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è

### –ü–æ–ª–Ω—ã–π –ø—Ä–∏–º–µ—Ä –æ–±—É—á–µ–Ω–∏—è

```python
from src.dataset import get_dataset
from torch_geometric.data import DataLoader
import torch

# –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞—Ç–∞—Å–µ—Ç–∞
dataset = get_dataset(
    name="peptides_func",
    root="./data",
    pe_config={
        "node": {"enabled": True, "types": ["rwse"], "dim": 32},
        "relative": {"enabled": True, "types": ["spd"], "num_buckets": 16}
    }
)

# –°–æ–∑–¥–∞–Ω–∏–µ DataLoader'–æ–≤
train_loader = DataLoader(dataset.train, batch_size=32, shuffle=True)
val_loader = DataLoader(dataset.val, batch_size=32, shuffle=False)

# –û–±—É—á–µ–Ω–∏–µ
for epoch in range(10):
    for batch in train_loader:
        # batch.x - node features
        # batch.node_pe - node positional encodings
        # batch.edge_pe - relative positional encodings
        # batch.y - targets
        # ... –≤–∞—à –∫–æ–¥ –æ–±—É—á–µ–Ω–∏—è ...
        pass
```

## üìö –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è

- –í—Å–µ –¥–∞—Ç–∞—Å–µ—Ç—ã –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–∏–º–µ–Ω—è—é—Ç PE —á–µ—Ä–µ–∑ transforms
- PE –≤—ã—á–∏—Å–ª—è—é—Ç—Å—è –æ–¥–∏–Ω —Ä–∞–∑ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –∏ –∫–µ—à–∏—Ä—É—é—Ç—Å—è –≤ –ø–∞–º—è—Ç–∏
- –ü–æ–¥–¥–µ—Ä–∂–∫–∞ –∫–∞–∫ –∫–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü–∏–∏, —Ç–∞–∫ –∏ —Ä–µ–≥—Ä–µ—Å—Å–∏–∏
- –°–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å —Å PyTorch Geometric DataLoader
- Graceful fallback –µ—Å–ª–∏ PE –æ—Ç–∫–ª—é—á–µ–Ω—ã (–Ω—É–ª–µ–≤—ã–µ PE)

## ü§ù –í–∫–ª–∞–¥

–ü—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ –Ω–æ–≤—ã—Ö –¥–∞—Ç–∞—Å–µ—Ç–æ–≤:
1. –°–æ–∑–¥–∞–π—Ç–µ –∫–ª–∞—Å—Å, –Ω–∞—Å–ª–µ–¥—É—é—â–∏–π `BaseGraphDataset`
2. –†–µ–∞–ª–∏–∑—É–π—Ç–µ –º–µ—Ç–æ–¥—ã `load()`, `num_features`, `num_classes`
3. –î–æ–±–∞–≤—å—Ç–µ –ø–æ–¥–¥–µ—Ä–∂–∫—É –≤ `factory.py`
4. –î–æ–±–∞–≤—å—Ç–µ —Ç–µ—Å—Ç—ã –≤ `test_dataset_loading.py`

